<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>線上預約後台管理</title>
<style>
body {
  font-family: "Microsoft JhengHei", sans-serif;
  background: #e8f5f3;
  margin: 0;
}
.wrapper {
  max-width: 900px;
  margin: 20px auto;
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
h2 { margin-top: 0; color:#0d7a63; }
label { margin-right: 8px; }
input, select {
  padding: 6px 8px;
  margin: 4px;
}
button {
  padding: 6px 12px;
  margin: 4px;
  background: #0d7a63;
  border: none;
  color: #fff;
  border-radius: 4px;
}
button.danger { background: #c62828; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 14px;
}
th, td {
  border: 1px solid #ddd;
  padding: 6px;
  text-align: center;
}
th { background: #f0f0f0; }
#loginPane {
  max-width: 360px;
  margin: 80px auto;
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
</style>
</head>
<body>

<div id="loginPane">
  <h2>後台登入</h2>
  <p>請輸入管理密碼：</p>
  <input type="password" id="loginPassword" placeholder="密碼">
  <br>
  <button onclick="login()">登入</button>
  <p id="loginMsg" style="color:red;"></p>
</div>

<div id="mainPane" style="display:none;">
  <div class="wrapper">
    <h2>線上預約後台管理</h2>

    <div>
      <label>關鍵字：</label>
      <input id="qKeyword" placeholder="姓名 / 電話 / 身分證">
      <label>日期：</label>
      <input type="date" id="qDate">
      <label>醫師：</label>
      <input id="qDoctor" placeholder="例如 吳立偉院長">
      <button onclick="loadData()">搜尋 / 重新整理</button>
      <button onclick="exportCSV()">匯出 CSV</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>編號</th>
          <th>姓名</th>
          <th>電話</th>
          <th>身分證/護照</th>
          <th>生日</th>
          <th>日期</th>
          <th>診別</th>
          <th>醫師</th>
          <th>建立時間</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="tbBody"></tbody>
    </table>
  </div>
</div>

<script>
const API_BASE = "https://clinic-booking-yb4u.onrender.com";
let adminPassword = "";

// 登入
async function login() {
  const pw = document.getElementById("loginPassword").value.trim();
  if (!pw) return;

  const res = await fetch(API_BASE + "/admin/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ password: pw })
  });

  const data = await res.json();
  if (res.ok && data.ok) {
    adminPassword = pw;
    document.getElementById("loginPane").style.display = "none";
    document.getElementById("mainPane").style.display = "block";
    loadData();
  } else {
    document.getElementById("loginMsg").textContent = data.error || "登入失敗";
  }
}

// 載入資料
async function loadData() {
  const keyword = document.getElementById("qKeyword").value.trim();
  const date = document.getElementById("qDate").value.trim();
  const doctor = document.getElementById("qDoctor").value.trim();

  const params = new URLSearchParams();
  if (keyword) params.append("keyword", keyword);
  if (date) params.append("date", date);
  if (doctor) params.append("doctor", doctor);

  const res = await fetch(API_BASE + "/admin/appointments?" + params.toString(), {
    headers: { "x-admin-password": adminPassword }
  });
  const data = await res.json();
  renderTable(data);
}

function renderTable(rows) {
  const tbody = document.getElementById("tbBody");
  tbody.innerHTML = "";
  if (!rows || !rows.length) {
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 10;
    td.textContent = "目前沒有符合條件的預約";
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }

  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${r.name}</td>
      <td>${r.phone}</td>
      <td>${r.idno}</td>
      <td>${r.birthday}</td>
      <td>${r.date}</td>
      <td>${r.section}</td>
      <td>${r.doctor}</td>
      <td>${r.created_at || ""}</td>
      <td>
        <button class="danger" onclick="del(${r.id})">刪除</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// 刪除
async function del(id) {
  if (!confirm("確定要刪除編號 " + id + " 的預約嗎？")) return;

  const res = await fetch(API_BASE + "/admin/appointments/" + id, {
    method: "DELETE",
    headers: { "x-admin-password": adminPassword }
  });
  const data = await res.json();
  if (res.ok && data.ok) {
    loadData();
  } else {
    alert(data.error || "刪除失敗");
  }
}

// 匯出 CSV
async function exportCSV() {
  const keyword = document.getElementById("qKeyword").value.trim();
  const date = document.getElementById("qDate").value.trim();
  const doctor = document.getElementById("qDoctor").value.trim();

  const params = new URLSearchParams();
  if (keyword) params.append("keyword", keyword);
  if (date) params.append("date", date);
  if (doctor) params.append("doctor", doctor);

  const res = await fetch(API_BASE + "/admin/export?" + params.toString(), {
    headers: { "x-admin-password": adminPassword }
  });
  const csv = await res.text();

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "appointments.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
